{% extends "base.html" %}
{% block title %}Manage Attendance - {{ course.code }}{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="text-primary fw-bold mb-2">
                <i class="bi bi-journal-check me-2"></i> {{ course.code }} — {{ course.title }}
            </h1>
            <p class="text-muted mb-0">
                <strong>Lecturer:</strong> {{ course.lecturer.name }} • 
                <strong>Level:</strong> {{ course.level * 100 }} Level • 
                <strong>Enrolled:</strong> {{ enrolled_students }} students
            </p>
        </div>
        <div>
            <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#openSessionModal">
                <i class="bi bi-plus-circle me-2"></i> Open New Session
            </button>
        </div>
    </div>

    <!-- Active Session Alert -->
    {% if active_session %}
    <div class="alert alert-warning text-center py-4 mb-5">
        <i class="bi bi-clock-history fs-1 mb-3 d-block"></i>
        <h4>Attendance Session is OPEN</h4>
        <p>Date: <strong>{{ active_session.date.strftime('%d %B %Y') }}</strong></p>
        <p>Closes at: <strong>{{ active_session.end_time.strftime('%H:%M') }}</strong></p>
        <form method="POST" action="{{ url_for('close_attendance_session', session_id=active_session.id) }}" class="d-inline">
            <button type="submit" class="btn btn-danger btn-lg">
                <i class="bi bi-lock me-2"></i> Close Session Now
            </button>
        </form>
    </div>
    {% endif %}

    <!-- Attendance Table - Always Visible -->
    <h4 class="fw-bold text-primary mb-4">
        <i class="bi bi-table me-2"></i> Attendance Record
        {% if sessions %}({{ total_sessions }} session{{ 's' if total_sessions != 1 else '' }}){% endif %}
    </h4>

    <div class="table-responsive">
        <table class="table table-hover align-middle text-center">
            <thead class="table-primary">
                <tr>
                    <th rowspan="2" class="align-middle text-start">Matric Number</th>
                    <th rowspan="2" class="align-middle text-start">Student Name</th>
                    <th colspan="{{ total_sessions }}" class="text-center">Sessions</th>
                    <th rowspan="2" class="align-middle">Total Present</th>
                    <th rowspan="2" class="align-middle">Percentage</th>
                </tr>
                <tr>
                    {% for session in sessions %}
                    <th>
                        {{ session.date.strftime('%d %b') }}<br>
                        <small class="text-muted">Week {{ loop.index }}</small>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for data in attendance_data %}
                <tr>
                    <td class="text-start"><code>{{ data.student.matric_number|upper }}</code></td>
                    <td class="text-start fw-bold">{{ data.student.name }}</td>
                    {% for status in data.session_status %}
                    <td>
                        {% if status == 'Present' %}
                        <i class="bi bi-check-circle-fill text-success fs-4"></i>
                        {% else %}
                        <i class="bi bi-x-circle-fill text-danger fs-4"></i>
                        {% endif %}
                    </td>
                    {% endfor %}
                    <td class="fw-bold">{{ data.present_count }} / {{ total_sessions }}</td>
                    <td>
                        <span class="badge fs-6 px-3 py-2 bg-{{ 'success' if data.percentage >= 75 else 'warning' if data.percentage >= 50 else 'danger' }}">
                            {{ data.percentage }}%
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if not sessions %}
    <div class="alert alert-info text-center py-5 mt-4">
        <i class="bi bi-calendar-x display-4 mb-3"></i>
        <p>No attendance sessions have been opened yet.</p>
        <p class="text-muted">Click "Open New Session" to begin taking attendance.</p>
    </div>
    {% endif %}
</div>

<!-- Open Session Modal -->
<div class="modal fade" id="openSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('open_attendance_session', course_id=course.id) }}">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Open New Attendance Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Session Date</label>
                        <input type="date" name="date" class="form-control form-control-lg" value="{{ today_date }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Duration (minutes)</label>
                        <select name="duration" class="form-select form-select-lg" required>
                            <option value="15">15 minutes</option>
                            <option value="30" selected>30 minutes</option>
                            <option value="45">45 minutes</option>
                            <option value="60">60 minutes</option>
                            <option value="90">90 minutes</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Open Session</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}